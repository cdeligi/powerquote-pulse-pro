name: Deploy Supabase (DB migrations + Edge Functions)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # NOTE (temporary): DB migration history in the remote project is out of sync with the repo.
      # `supabase db push` fails with "Remote migration versions not found in local migrations directory".
      # We will apply DB changes via SQL Editor until migration history is repaired.
      #
      # To re-enable:
      # - Run `supabase db pull` and commit missing migrations OR repair migration history.
      # - Then restore the db push step below.
      #
      #- name: Link + Deploy DB migrations
      #  env:
      #    SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      #    SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      #    SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      #  run: |
      #    supabase link --project-ref "$SUPABASE_PROJECT_REF"
      #    supabase db push

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          supabase functions deploy send-quote-status-email
          supabase functions deploy send-quote-notifications
          supabase functions deploy admin-users
          supabase functions deploy send-user-request-reminders

      # Note: Scheduling (cron) for reminders is configured in Supabase Dashboard.
      # We can automate scheduling via SQL+pg_cron+pg_net if desired.
